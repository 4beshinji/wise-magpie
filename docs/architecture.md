# アーキテクチャ概要

wise-magpie の内部設計と処理フローの解説です。

## システム全体のコンポーネント図

```
┌─────────────────────────────────────────────────────────┐
│                      CLI (cli.py)                       │
│  config | quota | schedule | tasks | review | start/stop│
└──────┬──────────────────────────────────────────────┬───┘
       │                                              │
       ▼                                              ▼
┌──────────────┐  ┌──────────────┐  ┌────────────────────┐
│ Config       │  │ Task Manager │  │ Daemon              │
│ (config.py)  │  │ (manager.py) │  │ (daemon/runner.py)  │
│              │  │              │  │                     │
│ TOML 読込    │  │ 追加/削除    │  │ メインループ        │
│ デフォルト値  │  │ スキャン     │  │ タスク実行          │
└──────┬───────┘  │ 優先度計算   │  │                     │
       │          └──────┬───────┘  └──────┬──────────────┘
       │                 │                 │
       │          ┌──────▼───────┐  ┌──────▼──────────────┐
       │          │ Task Sources │  │ Scheduler            │
       │          │              │  │ (daemon/scheduler.py)│
       │          │ git_todos    │  │                      │
       │          │ queue_file   │  │ 6段階実行判定        │
       │          │ auto_tasks   │  └──────┬───────────────┘
       │          └──────────────┘         │
       │                                   │
       │  ┌────────────────────────────────▼───────────┐
       │  │              Worker                         │
       │  │                                             │
       │  │  ┌─────────────┐  ┌───────────┐            │
       │  │  │ Executor    │  │ Sandbox   │            │
       │  │  │ Claude CLI  │  │ ブランチ   │            │
       │  │  │ 実行        │  │ 隔離      │            │
       │  │  └─────────────┘  └───────────┘            │
       │  │                                             │
       │  │  ┌─────────────┐  ┌───────────────────┐    │
       │  │  │ Monitor     │  │ Model Selector    │    │
       │  │  │ 予算ガード  │  │ 難度→モデル選択    │    │
       │  │  └─────────────┘  └───────────────────┘    │
       │  └─────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────┐
│                   Data Layer                      │
│                                                   │
│  ┌──────────┐  ┌──────────┐  ┌────────────────┐  │
│  │ Database │  │ Quota    │  │ Patterns       │  │
│  │ (db.py)  │  │ Estimator│  │ Activity       │  │
│  │ SQLite   │  │ Tracker  │  │ Predictor      │  │
│  └──────────┘  └──────────┘  └────────────────┘  │
└──────────────────────────────────────────────────┘
```

## ディレクトリ構造

```
src/wise_magpie/
├── __init__.py
├── cli.py                  # Click CLI コマンド定義
├── config.py               # TOML 設定管理
├── constants.py            # デフォルト定数・モデル定義
├── db.py                   # SQLite データベース層
├── models.py               # データモデル（Task, UsageRecord 等）
├── daemon/
│   ├── runner.py           # デーモンのメインループ・ライフサイクル
│   ├── scheduler.py        # 6段階実行判定ロジック
│   └── signals.py          # シグナルハンドラ（SIGTERM/SIGINT）
├── patterns/
│   ├── activity.py         # ユーザーアクティビティ検知
│   ├── predictor.py        # アイドルウィンドウ予測
│   └── schedule.py         # 学習済みパターン表示
├── quota/
│   ├── estimator.py        # クォータ推定・残量計算
│   ├── tracker.py          # 使用量記録・履歴表示
│   └── corrections.py      # 手動クォータ補正
├── review/
│   ├── reporter.py         # レビュー一覧・詳細表示
│   └── applicator.py       # マージ/却下実行
├── tasks/
│   ├── manager.py          # タスクキュー管理（CLI向け）
│   ├── model_selector.py   # 難度ベースのモデル選択
│   ├── prioritizer.py      # 優先度スコアリング
│   └── sources/
│       ├── auto_tasks.py   # 自動タスクテンプレート
│       ├── git_todos.py    # TODO/FIXME コメントスキャン
│       └── queue_file.py   # キューファイル読み取り
└── worker/
    ├── executor.py         # Claude CLI 実行ラッパー
    ├── monitor.py          # 予算ガード・実行監視
    └── sandbox.py          # Git ブランチ隔離
```

## デーモンのメインループ

デーモンは `poll_interval`（デフォルト 60 秒）ごとに以下の処理を繰り返します:

```
ループ開始
  │
  ├─ アクティビティ状態を記録
  │
  ├─ should_execute() で6段階チェック
  │   │
  │   ├─ True → get_next_task() でキューから取得
  │   │         → _run_single_task() でタスク実行
  │   │
  │   └─ False → 理由をログに記録
  │
  ├─ poll_interval 待機（シャットダウンシグナルで中断可能）
  │
  └─ シャットダウンシグナル受信時 → ループ終了
```

### 6 段階実行判定チェック

`daemon/scheduler.py` の `should_execute()` は以下の順に判定します:

| # | チェック | 条件（不合格で停止） |
|---|---------|-------------------|
| 1 | ユーザーアクティブ | `pgrep -f claude` でプロセスが検出されない |
| 2 | アイドル時間 | 最終アクティビティから `idle_threshold_minutes` 分以上経過 |
| 3 | 復帰予測 | 予測される復帰時刻まで `return_buffer_minutes` 分以上ある |
| 4 | 予算確認 | 日次予算上限に達していない＋クォータ残量あり |
| 5 | 待機タスク | キューに pending タスクが 1 つ以上ある |
| 6 | 実行中タスク | 現在実行中のタスクがない（同時実行は 1 タスクのみ） |

すべてのチェックを通過した場合のみタスクが実行されます。

## タスクライフサイクル

```
生成                  優先度付け             キュー
┌────────────┐      ┌────────────┐      ┌────────────┐
│ タスク源    │ ──→  │ スコア計算  │ ──→  │ DB (pending)│
│            │      │ 0〜100     │      │            │
│ manual     │      │            │      │ 優先度順    │
│ git_todo   │      │ source     │      │ ソート      │
│ queue_file │      │ + keyword  │      │            │
│ auto_task  │      │ + simplicity│     │            │
└────────────┘      └────────────┘      └──────┬─────┘
                                               │
                    ┌──────────────────────────┘
                    ▼
              ┌────────────┐
              │ 実行        │
              │ (running)   │
              │             │
              │ 1. モデル選択│
              │ 2. ブランチ  │
              │    作成      │
              │ 3. Claude   │
              │    CLI 実行  │
              │ 4. 結果記録  │
              └──────┬─────┘
                     │
            ┌────────┴────────┐
            ▼                 ▼
     ┌────────────┐    ┌────────────┐
     │ 完了        │    │ 失敗       │
     │ (completed) │    │ (failed)   │
     └──────┬─────┘    └────────────┘
            │
     ┌──────┴──────┐
     ▼             ▼
┌─────────┐  ┌─────────┐
│ 承認     │  │ 却下     │
│ approve  │  │ reject   │
│          │  │          │
│ マージ   │  │ ブランチ  │
│          │  │ 削除     │
└─────────┘  └─────────┘
```

## ブランチ隔離戦略

タスク実行時の安全性を確保するため、各タスクは専用の Git ブランチで実行されます。

### ブランチ命名規則

```
wise-magpie/{sanitized-task-name}
```

- タスク名は小文字化、スペースをハイフンに変換、英数字とハイフン/アンダースコアのみ保持
- 最大 50 文字に切り詰め
- 同名ブランチが存在する場合は `-{task_id}` を付加

### 実行フロー

1. 未コミット変更がないことを確認（あればエラー）
2. 現在のブランチを記録
3. `wise-magpie/{name}` ブランチを作成・チェックアウト
4. Claude CLI でタスクを実行
5. 元のブランチに戻る（作業ブランチはレビュー用に保持）

### レビュー・マージ

- `review approve` — 作業ブランチを `--no-ff` でマージし、ブランチを削除
- `review reject` — 作業ブランチを削除し、タスクステータスを `cancelled` に変更

## クォータ管理フロー

```
quota show
  │
  ├─ 現在のクォータウィンドウを取得（なければ作成）
  │
  ├─ 各モデルについて:
  │   │
  │   ├─ モデル上限を解決（config → constants → legacy）
  │   │
  │   ├─ 補正値あり?
  │   │   ├─ Yes → 補正残量 - 補正後の使用数
  │   │   └─ No  → 上限 - ウィンドウ開始からの使用数
  │   │
  │   └─ 残量・安全マージン・自律実行可能数を計算
  │
  └─ 表示
```

### 手動補正

Claude UI に表示される実際の残りメッセージ数で推定値を補正できます:

```bash
wise-magpie quota correct 180 -m sonnet
```

補正後の使用量は、補正時刻以降の `usage_log` レコードから計算されます。

## モデル選択フロー

```
select_model(task)
  │
  ├─ auto_select_model = false?
  │   └─ Yes → 設定のデフォルトモデルを返す
  │
  ├─ タスクに明示的モデル指定あり?
  │   └─ Yes → そのモデルを返す
  │
  ├─ 難度を判定（assess_difficulty）
  │   ├─ タイトル+説明のキーワードマッチ
  │   ├─ ソース種別バイアス（auto_task → simple 寄り）
  │   └─ 説明の長さヒューリスティック
  │
  ├─ 難度 → モデルマッピング
  │   ├─ SIMPLE  → Haiku
  │   ├─ MEDIUM  → Sonnet
  │   └─ COMPLEX → Opus
  │
  ├─ アップグレード判定
  │   ├─ ウィンドウ残り < 1.5h かつ残量 > 30%?
  │   └─ 長時間アイドル予測 かつ残量 > 40%?
  │       └─ Yes → 1段階アップグレード
  │
  └─ クォータチェック
      ├─ 選択モデルの残量あり? → そのまま返す
      └─ 残量なし? → 1段階ダウングレード（最大2回）
```

## タスクソース 4 種の詳細

### 1. 手動追加 (`manual`)

- CLI の `tasks add` コマンドで追加
- ユーザーが明示的にタイトル・説明・優先度・モデルを指定
- ベーススコア: 40

### 2. TODO コメントスキャン (`git_todo`)

- `git ls-files` で追跡ファイルを列挙
- 各ファイルから `TODO`/`FIXME`/`HACK`/`XXX` パターンをマッチ
- `source_ref` に `"ファイル名:行番号"` を記録
- ベーススコア: 20

### 3. キューファイル (`queue_file`)

- `.wise-magpie-tasks` または `wise-magpie-tasks.md` を検索
- `- [ ] テキスト` 形式の行をタスクとして抽出
- チェック済み `- [x]` は無視
- ベーススコア: 35

### 4. 自動タスク (`auto_task`)

- 11 種類のビルトインテンプレートから条件付きで生成
- `source_ref` に `"{task_type}:{YYYY-MM-DD}"` を記録
- ベーススコア: 25
- 詳細は [自動タスク詳細ガイド](./auto-tasks.md)

## 安全設計

wise-magpie は以下の多層的な安全策により、意図しない変更やコスト発生を防止します。

### 6 重チェック（実行判定）

デーモンは 6 段階のチェック（アクティビティ検知 → アイドル時間 → 復帰予測 → 予算 → 待機タスク → 同時実行制限）をすべて通過しないとタスクを実行しません。

### 予算ガード

- **タスク単位**: `max_task_usd`（デフォルト $2.00）でタスクごとのコストを制限
- **日次上限**: `max_daily_usd`（デフォルト $10.00）で 1 日の合計コストを制限
- Claude CLI の `--max-budget-usd` フラグにも予算を渡す

### ブランチ隔離

- すべてのタスクは `wise-magpie/*` ブランチで実行
- メインブランチに直接変更を加えない
- 未コミット変更がある場合は実行を拒否

### レビュー必須

- 完了タスクは `review approve` で明示的にマージするまでメインブランチに反映されない
- `review reject` で変更を破棄可能

### クォータ安全マージン

- 推定クォータの 15%（設定可能）をインタラクティブ利用のために確保
- 自律実行はこのマージンを超えて消費しない

### 復帰バッファ

- ユーザーの復帰が予測される 15 分前（設定可能）に新規タスク開始を停止

## データベーススキーマ概要

SQLite データベース（`wise-magpie.db`）に以下のテーブルを持ちます:

| テーブル | 説明 |
|---------|------|
| `usage_log` | API 使用量の記録（タイムスタンプ、モデル、トークン数、コスト） |
| `quota_windows` | クォータウィンドウの管理（開始時刻、上限、使用数、手動補正） |
| `quota_corrections` | モデル別のクォータ手動補正記録 |
| `tasks` | タスクキュー（タイトル、説明、ソース、ステータス、優先度、ブランチ等） |
| `schedule_patterns` | 曜日×時間帯のアクティビティパターン |
| `activity_sessions` | ユーザーのアクティビティセッション記録 |

### 主なインデックス

- `idx_usage_timestamp` — 使用量の時系列検索
- `idx_tasks_status` — ステータス別のタスク検索
- `idx_activity_start` — アクティビティセッションの時系列検索

---

次のステップ: [トラブルシューティング](./troubleshooting.md) で問題解決の手順を確認
